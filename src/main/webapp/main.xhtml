<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:c="http://java.sun.com/jstl/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:fn="http://xmlns.jcp.org/jsp/jstl/functions">

<f:view afterPhase="#{queryBean.afterPhase}" />

<ui:include src="templates/head.xhtml">
    <ui:param name="pageTitle" value="Основная страница"/>
</ui:include>

<h:body>
    <div class="title">Основная страница</div>

    <h:graphicImage library="images" name="batman.png" id="batmanImage" class="scriptImage"/>
    <h:graphicImage library="images" name="bullet-hole-green.png" id="bulletHoleGreenImage" class="scriptImage"/>
    <h:graphicImage library="images" name="bullet-hole-red.png" id="bulletHoleRedImage" class="scriptImage"/>
    <canvas id="areaCanvas" width="400" height="400"/>

    <h:outputText id="historyPoints" value="#{queryBean.pointsJson}" style="display: none;" />

    <h:form id="areaForm" prependId="false">
        <h:inputText id="areaXField" value="#{queryBean.x}"
                     required="true" requiredMessage="Вы не выбрали X."
                     converter="Lab3_Web.BigDecimal" converterMessage="X должен быть числом." />

        <h:inputText id="areaYField" value="#{queryBean.y}"
                     required="true" requiredMessage="Вы не выбрали Y."
                     converter="Lab3_Web.BigDecimal" converterMessage="Y должен быть числом." />

        <h:inputText id="areaRField" value="#{queryBean.r}"
                     required="true" requiredMessage="Вы не выбрали R."
                     converter="Lab3_Web.BigDecimal" converterMessage="R должен быть числом."
                     validator="#{queryBean.validateR}" validatorMessage="Вы выбрали недопустимый R." />

        <p:commandButton id="areaFormButton" action="#{queryBean.action}"
                         update="historyPoints historyTable" oncomplete="area.queue.next(); reloadHistory();" />

        <h:message for="areaXField"/>
        <h:message for="areaYField"/>
        <h:message for="areaRField"/>
    </h:form>

    <h:form id="mainForm" prependId="false">
        <table>
            <tr>
                <td><h:outputLabel value="X: "/></td>
                <td>
                    <h:selectOneRadio id="xField" value="#{queryBean.x}" label="X"
                                      required="true" requiredMessage="Вы не выбрали X."
                                      converter="Lab3_Web.BigDecimal" converterMessage="X должен быть числом."
                                      validator="#{queryBean.validateX}" validatorMessage="Вы выбрали недопустимый X.">
                        <c:forEach items="#{queryBean.availableX}" var="item">
                            <f:selectItem itemValue="#{item}" itemLabel="#{item}"/>
                        </c:forEach>
                    </h:selectOneRadio>
                </td>
            </tr>

            <tr>
                <td><h:outputLabel value="Y: " for="yField"/></td>
                <td>
                    <h:inputText id="yField" value="#{queryBean.y}" label="Y"
                                 required="true" requiredMessage="Вы не ввели Y."
                                 converter="Lab3_Web.BigDecimal" converterMessage="Y должен быть числом."
                                 validator="#{queryBean.validateY}" validatorMessage="Y должен входить в интервал (-3, 5)." />
                </td>
            </tr>

            <tr>
                <td><h:outputLabel value="R: "/></td>
                <td>
                    <h:inputText id="rField" value="#{queryBean.r}" label="R"
                                 required="true" requiredMessage="Вы не выбрали R."
                                 converter="Lab3_Web.BigDecimal" converterMessage="R должен быть числом."
                                 validator="#{queryBean.validateR}" validatorMessage="Вы выбрали недопустимый R." />
                </td>
            </tr>

            <tr>
                <td/>
                <td>
                    <p:slider for="rField" minValue="#{queryBean.availableR[0]}" step="0.25"
                              maxValue="#{queryBean.availableR[fn:length(queryBean.availableR) - 1]}"
                              onSlide="area.onRChanged(ui.value);" />
                </td>
            </tr>
        </table>

        <p:commandButton action="#{queryBean.action}" value="Проверить"
                         update="historyPoints historyTable" oncomplete="reloadHistory();" />
    </h:form>

    <ui:include src="templates/homepage.xhtml" />

    <h:panelGroup id="historyTable">
        <h:panelGroup rendered="#{not empty historyBean.queries}">
            <p:dataTable styleClass="historyTable" style="overflow: hidden;"
                         var="query" value="#{historyBean}" sortOrder="descending"
                         paginator="true" rows="20" lazy="true">
                <p:column headerText="X" style="white-space: nowrap;">#{query.x}</p:column>
                <p:column headerText="Y" style="word-break: break-all;">#{query.y}</p:column>
                <p:column headerText="R" style="white-space: nowrap;">#{query.r}</p:column>
                <p:column headerText="результат" style="white-space: nowrap;">#{query.result ? 'есть пробитие' : 'промазал'}</p:column>
            </p:dataTable>

            <ui:include src="templates/homepage.xhtml"/>
        </h:panelGroup>
    </h:panelGroup>

    <h:outputScript library="js" name="area.js"/>

    <script type="text/javascript">
        function reloadHistory() {
            area.setHistory(JSON.parse(document.getElementById("historyPoints").innerText));
        }

        document.body.onload = () => {
            (function (input) {
                area.onRChanged(input.value);
                input.readOnly = true;
            })(document.getElementById('rField'));

            reloadHistory();
        };
    </script>
</h:body>
</html>
